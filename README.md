# setup-backup

Утилита для автоматической архивной копии (бэкапа) локального каталога/файла на удалённый сервер по SSH с использованием `scp` или `rsync`, с опциональным сжатием, ротацией копий и уведомлениями в Telegram. Запуск по расписанию реализован через `systemd timer`.

## Возможности
- **Передача**: `scp` (простая копия) или `rsync` (синхронизация)
- **Сжатие**: `zip`, `tar.gz` или без сжатия (`none`)
- **Ротация**: хранение ограниченного числа архивов на удалённой стороне
- **Расписание**: запуск через `systemd` по выражению `OnCalendar`
- **Уведомления**: отправка статуса в Telegram ботом
- **Логи**: подробный лог работы в `/opt/backup/backup.log`

## Требования
- Linux с `systemd`
- Доступ к `sudo`
- Пакеты: `zip`, `tar`, `rsync`, `curl` (скрипт установит через `pacman` при необходимости)
- Рабочий SSH-доступ к целевому серверу и приватный ключ с правами `600`

## Быстрый старт
1. Отредактируйте `setup-backup.sh` при необходимости и запустите:
   ```bash
   sudo bash setup-backup.sh
   ```
2. При первом запуске будет создан конфиг `/opt/backup/backup.conf`. Отредактируйте его под себя и перезапустите скрипт.
3. Скрипт проверит конфиг, подключение по SSH, создаст сервис/таймер и включит расписание.

## Конфигурация: `/opt/backup/backup.conf`
Пример (создаётся автоматически при первом запуске):
```bash
# Путь к файлу или папке для бэкапа (например, /home/su/dockerImg)
BACKUP_SRC="/home/su/dockerImg"
# Протокол передачи: scp (простая копия по SSH) или rsync (синхронизация)
TRANSFER_PROTOCOL="scp"
# Адрес удаленного сервера: user@host:/path (например, user@1.2.3.4:/home/user/backups)
BACKUP_DEST="user@host:/remote/path"
# Расписание systemd-таймера (например, *-*-* 23:15:00 для ежедневного запуска в 23:15)
SCHEDULE="*-*-* 23:15:00"
# Тип сжатия: zip, tar.gz или none (без сжатия)
COMPRESSION="tar.gz"
# Ротация бэкапов: yes (удалять старые) или no (сохранять все)
ROTATION_ENABLED="yes"
# Максимальное количество бэкапов для хранения (0 = отключить ротацию)
MAX_BACKUPS="3"
# Формат имени архива (например, backup_%Y%m%d_%H%M%S)
ARCHIVE_NAME_FORMAT="backup_%Y%m%d_%H%M%S"
# Уведомления в Telegram: yes или no
TELEGRAM_NOTIFICATIONS="no"
# Токен Telegram-бота (получите через @BotFather)
TELEGRAM_BOT_TOKEN=""
# ID чата для уведомлений (узнайте через @getmyid_bot)
TELEGRAM_CHAT_ID=""
# Путь к SSH-ключу (используемый root при запуске сервиса)
SSH_KEY="/home/you/.ssh/id_rsa"
```

### Пояснения к полям
- **BACKUP_SRC**: исходный путь (каталог или файл) для резервного копирования.
- **TRANSFER_PROTOCOL**: `scp` для простого копирования, `rsync` — для инкрементальной синхронизации и экономии трафика.
- **BACKUP_DEST**: формат `user@host:/remote/path`. Папка создаётся на удалённой стороне автоматически.
- **SCHEDULE**: выражение `OnCalendar` (см. `man systemd.timer`). Примеры:
  - Ежедневно 23:15: `*-*-* 23:15:00`
  - Каждый час: `*:00:00`
  - Каждое воскресенье в 03:00: `Sun 03:00:00`
- **COMPRESSION**: `tar.gz` подходит для каталогов; `zip` — альтернатива; `none` — передача исходников без архивации.
- **ROTATION_ENABLED/MAX_BACKUPS**: при `yes` на удалённой стороне будут храниться последние `MAX_BACKUPS` архивов по префиксу имени.
- **ARCHIVE_NAME_FORMAT**: шаблон даты/времени `date +"..."`. Используйте только символы, допустимые в именах файлов.
- **TELEGRAM_*:** включите при необходимости уведомления (успех/ошибка).
- **SSH_KEY**: приватный ключ, доступный root (скрипт настраивает `known_hosts` для root). Права файла должны быть `600`.

## Как это работает
- Скрипт создаёт рабочие файлы:
  - Конфиг: `/opt/backup/backup.conf`
  - Лог: `/opt/backup/backup.log`
  - Рабочий скрипт: `/opt/backup/backup.sh`
- Настраивает `systemd`:
  - Сервис: `backup.service` (oneshot)
  - Таймер: `backup.timer` c `OnCalendar=${SCHEDULE}`
- Перед запуском проверяется конфигурация и SSH-доступ. На удалённой стороне создаётся целевой каталог.

## Ручной запуск и проверка
- Разовая проверка:
  ```bash
  sudo systemctl start backup.service
  sudo journalctl -u backup.service -n 200 -e | cat
  ```
- Проверка таймера:
  ```bash
  systemctl list-timers | grep backup
  sudo systemctl status backup.timer | cat
  ```
- Логи:
  ```bash
  sudo tail -f /opt/backup/backup.log
  ```

## Ротация копий
Если включена, на удалённом сервере автоматически удаляются более старые архивы, превышающие `MAX_BACKUPS`, согласно префиксу `ARCHIVE_NAME_FORMAT`.

## Уведомления Telegram
1. Создайте бота через `@BotFather` и получите токен.
2. Получите `chat_id` (например, через `@getmyid_bot`).
3. Установите в конфиге `TELEGRAM_NOTIFICATIONS="yes"`, `TELEGRAM_BOT_TOKEN`, `TELEGRAM_CHAT_ID`.
4. Сообщения об успехе/ошибке будут отправляться ботом.

## Безопасность
- Храните приватный ключ с правами `600`.
- Ограничьте права на `/opt/backup/backup.conf` (создаётся с `644`; при использовании токенов/секретов рассмотрите `chmod 600`).
- Не храните реальные токены в VCS. Значения в примере — шаблоны.

## Частые проблемы
- «Неверный формат SCHEDULE»: проверьте выражение `OnCalendar` (`systemd-analyze calendar "<expr>"`).
- «SSH_KEY не существует/неверные права»: путь должен существовать, права — `600`.
- Не подключается по SSH: проверьте доступность хоста, ключи, `known_hosts`, брандмауэр.
- Ошибки передачи: смотрите `/opt/backup/backup.log` и `journalctl -u backup.service`.

## Обновление/удаление
- Изменить расписание/настройки: правьте `/opt/backup/backup.conf`, затем перезапустите таймер:
  ```bash
  sudo systemctl daemon-reload
  sudo systemctl restart backup.timer
  ```
- Отключить расписание:
  ```bash
  sudo systemctl disable --now backup.timer
  ```

## Лицензия
Используйте и изменяйте на свой риск. Автор не несёт ответственности за потерю данных. Создавайте и проверяйте резервные копии осознанно. 